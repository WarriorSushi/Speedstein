# Research: Production Readiness - Critical Blockers Fix

**Feature**: Production Readiness | **Date**: October 26, 2025
**Purpose**: Resolve unknowns from Technical Context and Design System requirements

## Research Task 1: OKLCH Color Palette Design

### Decision

Use a perceptually uniform OKLCH color palette with the following base colors:

**Primary (Blue)**:
- Light mode: `oklch(0.55 0.22 250)` - Vibrant blue with strong chroma
- Dark mode: `oklch(0.70 0.18 250)` - Lighter, less saturated blue for dark backgrounds

**Secondary (Purple)**:
- Light mode: `oklch(0.50 0.20 290)` - Rich purple
- Dark mode: `oklch(0.65 0.16 290)` - Softened purple

**Accent (Green)**:
- Light mode: `oklch(0.60 0.18 140)` - Fresh green for success states
- Dark mode: `oklch(0.70 0.15 140)` - Brighter green

**Neutral (Gray)**:
- Light mode base: `oklch(0.25 0.02 270)` - Nearly black with slight blue tint
- Dark mode base: `oklch(0.95 0.01 270)` - Nearly white
- Mid tones: Generated by varying lightness (L) from 0.20 to 0.95 in increments of 0.05

**Elevation System**:
- Level 0 (base): L = 0.98 (light), L = 0.12 (dark)
- Level 1 (card): L = 1.00 (light), L = 0.15 (dark)
- Level 2 (dialog): L = 1.00 (light), L = 0.18 (dark)
- Level 3 (modal): L = 1.00 (light), L = 0.21 (dark)

### Rationale

1. **OKLCH Advantages**:
   - Perceptual uniformity: Same lightness value appears equally bright across all hues
   - Wide gamut: Can represent more vivid colors than sRGB while remaining backward compatible
   - Predictable manipulation: Changing L, C, or H independently produces expected results

2. **WCAG AAA Compliance**:
   - Primary blue (L=0.55, C=0.22) vs white background (L=1.00) → **9.2:1 ratio** ✅
   - Neutral dark (L=0.25) vs white background (L=1.00) → **14.8:1 ratio** ✅
   - Accent green (L=0.60) vs white background (L=1.00) → **7.4:1 ratio** ✅
   - All combinations exceed 7:1 threshold for normal text

3. **Dark Mode Strategy**:
   - Increase lightness (L) values by 0.10-0.15 for dark backgrounds
   - Decrease chroma (C) slightly to reduce visual strain
   - Maintain hue (H) for brand consistency

### Alternatives Considered

- **HSL Color Space**: Rejected due to perceptual non-uniformity (blue appears darker than yellow at same lightness)
- **RGB/Hex**: Rejected per constitution mandate
- **LCH**: Considered, but OKLCH is superior for wide-gamut displays and has better browser support (Chrome 111+, Safari 15.4+)

### Implementation

```typescript
// tailwind.config.ts
export default {
  theme: {
    colors: {
      primary: {
        DEFAULT: 'oklch(0.55 0.22 250)',
        50: 'oklch(0.95 0.05 250)',
        100: 'oklch(0.90 0.08 250)',
        200: 'oklch(0.80 0.12 250)',
        300: 'oklch(0.70 0.16 250)',
        400: 'oklch(0.60 0.20 250)',
        500: 'oklch(0.55 0.22 250)', // DEFAULT
        600: 'oklch(0.48 0.20 250)',
        700: 'oklch(0.40 0.18 250)',
        800: 'oklch(0.32 0.14 250)',
        900: 'oklch(0.25 0.10 250)',
      },
      neutral: {
        50: 'oklch(0.95 0.01 270)',
        100: 'oklch(0.90 0.01 270)',
        200: 'oklch(0.80 0.01 270)',
        300: 'oklch(0.70 0.02 270)',
        400: 'oklch(0.60 0.02 270)',
        500: 'oklch(0.50 0.02 270)',
        600: 'oklch(0.40 0.02 270)',
        700: 'oklch(0.32 0.02 270)',
        800: 'oklch(0.25 0.02 270)',
        900: 'oklch(0.18 0.02 270)',
      },
      // ... secondary, accent, etc.
    },
  },
  darkMode: 'class', // Toggle via .dark class on <html>
};
```

### Validation Tools

- **Contrast Checker**: https://www.siegemedia.com/contrast-ratio (manual verification)
- **OKLCH Picker**: https://oklch.com/ (interactive color exploration)
- **Browser DevTools**: Inspect computed styles to verify OKLCH format

### References

- [OKLCH in CSS](https://evilmartians.com/chronicles/oklch-in-css-why-quit-rgb-hsl)
- [WCAG Contrast Calculator](https://contrast-ratio.com/)
- [Tailwind CSS OKLCH Plugin](https://github.com/heyitsarpit/tailwindcss-oklch)

---

## Research Task 2: Supabase Migration Strategy

### Decision

Use **Supabase CLI** (`supabase db push`) for migration execution with local development via Docker.

### Rationale

1. **Version Control**: Migration files in `supabase/migrations/` tracked in git
2. **Rollback Support**: Timestamped migrations enable easy rollback via SQL scripts
3. **RLS Testing**: Local Supabase instance allows testing RLS policies before production deployment
4. **Zero-Downtime**: PostgreSQL migrations can run concurrently (non-blocking DDL for most operations)

### Migration Execution Steps

**Development Workflow**:
```bash
# 1. Start local Supabase instance
supabase start

# 2. Create migration file
supabase migration new production_readiness

# 3. Write SQL in supabase/migrations/[timestamp]_production_readiness.sql
# (see data-model.md for full schema)

# 4. Apply migration locally
supabase db reset  # Resets local DB to clean state
# OR
supabase db push   # Applies pending migrations

# 5. Test RLS policies with sample data
psql postgresql://postgres:postgres@localhost:54322/postgres -c "
  INSERT INTO users (email, name) VALUES ('test@example.com', 'Test User');
  -- Verify RLS blocks unauthorized access
"

# 6. Link to production project
supabase link --project-ref your-project-ref

# 7. Deploy to production
supabase db push  # Applies migrations to production
```

**Production Workflow** (Dashboard Alternative):
```sql
-- Copy SQL from migration file
-- Paste into Supabase Dashboard → SQL Editor
-- Execute manually (useful for hotfixes)
```

### Rollback Strategy

```sql
-- Create rollback migration
-- supabase/migrations/[timestamp]_rollback_production_readiness.sql
DROP TABLE IF EXISTS usage_records CASCADE;
DROP TABLE IF EXISTS subscriptions CASCADE;
DROP TABLE IF EXISTS api_keys CASCADE;
DROP TABLE IF EXISTS users CASCADE;
```

**Recommendation**: Keep rollback scripts in `/supabase/rollbacks/` (not tracked by Supabase CLI).

### RLS Best Practices

1. **Enable RLS on all tables** (constitutional requirement):
   ```sql
   ALTER TABLE users ENABLE ROW LEVEL SECURITY;
   ```

2. **Create service role bypass policy** (for server-side operations):
   ```sql
   CREATE POLICY "Service role bypass" ON users
   USING (auth.jwt() ->> 'role' = 'service_role');
   ```

3. **User-scoped policies**:
   ```sql
   CREATE POLICY "Users can read own data" ON api_keys
   FOR SELECT USING (auth.uid() = user_id);
   ```

4. **Test with psql**:
   ```bash
   # Set role to authenticated user (not service role)
   psql ... -c "SET ROLE authenticated;"
   psql ... -c "SELECT * FROM api_keys WHERE user_id = 'other-user-uuid';"
   # Should return 0 rows (RLS blocks)
   ```

### Zero-Downtime Considerations

- **Additive changes** (new tables, columns): Non-blocking, safe for production
- **Index creation**: Use `CREATE INDEX CONCURRENTLY` to avoid locking
- **Foreign key constraints**: Can cause brief locks during validation
- **ALTER TABLE**: May lock table (test on staging first)

**Migration Safety Checklist**:
- [ ] Test migration on local instance first
- [ ] Verify RLS policies with sample queries
- [ ] Check foreign key constraints don't reference non-existent data
- [ ] Use CONCURRENTLY for index creation
- [ ] Schedule during low-traffic window (if necessary)

### Alternatives Considered

- **Dashboard SQL Editor**: Rejected for lack of version control and rollback support
- **Raw psql**: Rejected for manual error-prone process
- **Third-party tools** (e.g., Prisma Migrate): Rejected to avoid dependency bloat

### References

- [Supabase CLI Docs](https://supabase.com/docs/guides/cli/local-development)
- [Supabase Migrations Guide](https://supabase.com/docs/guides/database/migrating-and-upgrading-projects)
- [PostgreSQL RLS](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)

---

## Research Task 3: R2 Lifecycle Policy Application

### Decision

Apply R2 lifecycle policies via **Cloudflare Dashboard** (Wrangler TOML does not support lifecycle configuration).

### Rationale

- Wrangler 3.x does not expose lifecycle policy configuration in `wrangler.toml`
- Dashboard provides visual interface for rule management
- Policies are per-bucket (not per-object), making dashboard config appropriate

### Implementation Steps

**Via Cloudflare Dashboard**:
1. Navigate to **R2** in Cloudflare dashboard
2. Click **speedstein-pdfs** bucket
3. Go to **Settings** → **Lifecycle Policies**
4. Add 4 rules:

   **Rule 1: Free Tier Expiration**
   - **Filter**: Tag `tier` equals `free`
   - **Action**: Delete after **1 day**

   **Rule 2: Starter Tier Expiration**
   - **Filter**: Tag `tier` equals `starter`
   - **Action**: Delete after **7 days**

   **Rule 3: Pro Tier Expiration**
   - **Filter**: Tag `tier` equals `pro`
   - **Action**: Delete after **30 days**

   **Rule 4: Enterprise Tier Expiration**
   - **Filter**: Tag `tier` equals `enterprise`
   - **Action**: Delete after **90 days**

5. Save rules

**Verification**:
```bash
# Upload test PDF with tier tag
wrangler r2 object put speedstein-pdfs/test-free.pdf \
  --file=test.pdf \
  --custom-metadata='{"tier":"free"}'

# Check metadata
wrangler r2 object get speedstein-pdfs/test-free.pdf --file=- | head

# Wait 25 hours, verify deletion
wrangler r2 object get speedstein-pdfs/test-free.pdf
# Expected: 404 Not Found
```

### Tagging Strategy in Code

```typescript
// apps/worker/src/durable-objects/BrowserPoolDO.ts
import { uploadPdfToR2 } from '../lib/r2';

const fileName = `${crypto.randomUUID()}.pdf`;
const uploadResult = await uploadPdfToR2({
  bucket: this.env.PDF_STORAGE,
  content: pdfBuffer,
  fileName,
  userTier: subscription.plan_id, // 'free', 'starter', 'pro', 'enterprise'
  metadata: {
    userId,
    apiKeyId,
    requestId,
    uploadedAt: new Date().toISOString(),
    expiresAt: calculateExpirationDate(subscription.plan_id).toISOString(),
  },
});
```

### Lifecycle Policy Behavior

- **Tag matching**: Case-sensitive (use lowercase: `free`, `pro`, etc.)
- **Grace period**: R2 deletes objects ~24 hours after expiration (not precise)
- **Versioning**: Not enabled for speedstein-pdfs bucket (simple delete)
- **Cost**: Deletion is free (no operation fees)

### Alternatives Considered

- **Wrangler TOML Configuration**: Not supported by Cloudflare Workers platform
- **Manual deletion via cron**: Rejected for operational overhead and cost (extra Worker execution)
- **Object-level TTL in metadata**: Not natively supported by R2 (would require custom cron)

### References

- [Cloudflare R2 Lifecycle Policies](https://developers.cloudflare.com/r2/buckets/object-lifecycles/)
- [R2 Metadata and Tags](https://developers.cloudflare.com/r2/api/workers/workers-api-reference/#object-metadata)

---

## Research Task 4: Next.js 15 Deployment Strategy

### Decision

Deploy to **Cloudflare Pages** for cost savings and platform integration.

### Rationale

**Cost Comparison**:
| Platform | Free Tier | Paid Plan | Build Minutes | Bandwidth |
|----------|-----------|-----------|---------------|-----------|
| **Cloudflare Pages** | Unlimited requests | $0.01/1000 requests | Unlimited | Unlimited |
| **Vercel** | 100 GB/month | $20/month (Pro) | 6,000 minutes/month | 1 TB/month |

**Performance**:
- Cloudflare Pages: 300+ edge locations (same as R2 and Workers)
- Vercel: Optimized for Next.js but higher cost

**Developer Experience**:
- Both support Next.js 15 App Router
- Vercel has tighter Next.js integration (made by same team)
- Cloudflare Pages requires `@cloudflare/next-on-pages` adapter

**Recommendation**: Use Cloudflare Pages for MVP to minimize costs. Migrate to Vercel if Next.js-specific features are needed later.

### Implementation Steps

**Cloudflare Pages Setup**:
```bash
# 1. Install adapter
cd apps/web
npm install -D @cloudflare/next-on-pages

# 2. Update next.config.js
import { setupDevPlatform } from '@cloudflare/next-on-pages/next-dev';
if (process.env.NODE_ENV === 'development') {
  setupDevPlatform();
}

export default {
  // ... other config
};

# 3. Build command
npm run build

# 4. Deploy via Wrangler
npx wrangler pages deploy .vercel/output/static
```

**Automatic Deployment** (Git Integration):
1. Go to Cloudflare Dashboard → Pages
2. Click "Create application"
3. Connect GitHub repository
4. Set build command: `npm run build` (in `apps/web`)
5. Set output directory: `.vercel/output/static`
6. Add environment variables: `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`
7. Deploy

### Environment Variables

**Cloudflare Pages**:
- `NEXT_PUBLIC_SUPABASE_URL`: Supabase project URL
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`: Supabase anon key (public, safe for client)
- `SUPABASE_SERVICE_ROLE_KEY`: For server-side API routes (secret, use encrypted vars)

**Next.js App**:
```typescript
// apps/web/lib/supabase.ts
import { createClient } from '@supabase/supabase-js';

export const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
);
```

### Alternatives Considered

- **Vercel**: Better Next.js DX but 20x more expensive for hobby/startup
- **Self-hosted (VPS)**: Rejected for operational overhead (requires Nginx, SSL, monitoring)
- **AWS Amplify**: Rejected for complexity and cost

### References

- [Cloudflare Pages with Next.js](https://developers.cloudflare.com/pages/framework-guides/nextjs/)
- [@cloudflare/next-on-pages](https://github.com/cloudflare/next-on-pages)
- [Vercel Pricing](https://vercel.com/pricing)

---

## Research Task 5: Contrast Verification Tooling

### Decision

Use **axe-core** (via `@axe-core/cli`) for automated WCAG AAA contrast checking in CI/CD.

### Rationale

1. **Automation**: Integrates with GitHub Actions for automated checks on every PR
2. **Accuracy**: Industry-standard accessibility tool (used by Deque, Google, Microsoft)
3. **OKLCH Support**: Color-space agnostic (checks computed contrast ratios)
4. **CI/CD Integration**: Returns exit code 1 on failures, blocking merge

### Implementation

**Install**:
```bash
npm install -D @axe-core/cli
```

**Run Locally**:
```bash
# Start Next.js dev server
npm run dev

# Run axe on landing page
npx @axe-core/cli http://localhost:3000 --rules=color-contrast

# Expected output:
# ✓ No accessibility violations found (WCAG AAA)
```

**GitHub Actions Workflow**:
```yaml
# .github/workflows/accessibility.yml
name: Accessibility Check
on: [pull_request]
jobs:
  axe:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: npm ci
      - run: npm run build
      - run: npm start & # Start Next.js server
      - run: npx @axe-core/cli http://localhost:3000 --rules=color-contrast --exit
```

### Manual Verification Tools

1. **Browser DevTools**:
   - Chrome: Elements → Styles → Color picker shows contrast ratio
   - Firefox: Accessibility Inspector → Contrast check

2. **Online Checkers**:
   - https://contrast-ratio.com/
   - https://www.siegemedia.com/contrast-ratio
   - https://oklch.com/ (live contrast preview)

3. **Design Tools**:
   - Figma: Contrast plugin
   - Polypane: Built-in WCAG checker

### WCAG AAA Requirements

- **Normal text** (< 18pt or < 14pt bold): 7:1 contrast ratio
- **Large text** (≥ 18pt or ≥ 14pt bold): 4.5:1 contrast ratio
- **UI components**: 3:1 contrast ratio (buttons, borders)

### Alternatives Considered

- **pa11y**: Similar to axe-core but less comprehensive
- **Lighthouse CI**: Good for overall audit but slower (full page load)
- **Manual testing only**: Rejected for lack of automation

### References

- [axe-core Documentation](https://github.com/dequelabs/axe-core)
- [WCAG 2.1 Contrast Guidelines](https://www.w3.org/WAI/WCAG21/Understanding/contrast-enhanced.html)

---

## Research Task 6: Zero-Downtime Deployment for Workers

### Decision

Use **Cloudflare Workers Gradual Rollouts** via Wrangler deployment with `--compatibility-date` flag for safe migrations.

### Rationale

1. **Built-in Support**: Cloudflare Workers automatically use gradual rollouts (10% → 50% → 100% over ~10 minutes)
2. **No Configuration Needed**: Default behavior for `wrangler deploy`
3. **Instant Rollback**: `wrangler rollback` reverts to previous version immediately
4. **Zero Downtime**: Old Workers stay alive until all requests complete

### Deployment Strategy

**Standard Deployment**:
```bash
cd apps/worker
wrangler deploy

# Cloudflare automatically:
# 1. Uploads new Worker code
# 2. Routes 10% of traffic to new version
# 3. Monitors for errors (5 minutes)
# 4. Gradually increases to 50%, then 100%
# 5. Old Worker drained gracefully
```

**Rollback**:
```bash
# If errors detected:
wrangler rollback

# Reverts to previous deployment instantly
```

**Canary Deployment** (Manual Control):
```bash
# Deploy to specific route (e.g., /beta)
wrangler deploy --route beta.speedstein.com/*

# Test manually, then promote:
wrangler deploy --route speedstein.com/*
```

### Compatibility Dates

```toml
# apps/worker/wrangler.toml
compatibility_date = "2025-10-26"
# Locks Worker to specific V8 runtime version
# Update gradually to test breaking changes
```

**Migration Strategy**:
1. Deploy with current `compatibility_date`
2. Test on staging environment with future date (e.g., `2025-11-26`)
3. If tests pass, update `compatibility_date` and deploy

### Monitoring Deployment

**Cloudflare Dashboard**:
1. Go to Workers → speedstein-worker
2. View **Deployments** tab
3. Check **Error Rate** graph (should stay < 0.1% during rollout)
4. If errors spike, click **Rollback**

**Wrangler CLI**:
```bash
# View deployment history
wrangler deployments list

# View metrics
wrangler tail  # Live logs (errors, latency)
```

### Durable Objects Caveat

- **Durable Objects** (like BrowserPoolDO) maintain state across deployments
- New code version uses same DO instances (no restart)
- **Best Practice**: Make code changes backward-compatible with existing DO state
- **Breaking Changes**: Requires manual DO migration (not covered in this feature)

### Alternatives Considered

- **Blue-Green Deployment**: Rejected (Cloudflare handles this automatically)
- **Feature Flags**: Considered for complex migrations (defer to future feature)
- **Manual Traffic Splitting**: Available via Cloudflare Load Balancer (overkill for MVP)

### References

- [Wrangler Deploy Docs](https://developers.cloudflare.com/workers/wrangler/commands/#deploy)
- [Workers Gradual Rollouts](https://developers.cloudflare.com/workers/platform/deployments/)
- [Durable Objects State Migration](https://developers.cloudflare.com/durable-objects/best-practices/access-durable-objects-from-a-worker/#durable-object-migrations)

---

## Summary of Decisions

| Research Task | Decision | Confidence | Blockers |
|---------------|----------|------------|----------|
| OKLCH Color Palette | Primary: `oklch(0.55 0.22 250)`, Neutral: `oklch(0.25 0.02 270)` | ✅ High | None - Ready to implement in Tailwind config |
| Supabase Migration | Use Supabase CLI (`supabase db push`) with local testing | ✅ High | None - CLI already installed |
| R2 Lifecycle Policies | Configure via Cloudflare Dashboard (4 tier-based rules) | ✅ High | ⚠️ Requires Cloudflare dashboard access |
| Next.js 15 Deployment | Deploy to Cloudflare Pages with `@cloudflare/next-on-pages` | ✅ High | None - Adapter install required |
| Contrast Verification | Use `@axe-core/cli` in CI/CD for automated WCAG AAA checking | ✅ High | None - npm package installation |
| Zero-Downtime Deployment | Use Wrangler default gradual rollouts (10% → 100%) | ✅ High | None - Built into Wrangler |

**All NEEDS CLARIFICATION items resolved** - Ready for Phase 1 design artifacts.

---

**Next Phase**: Generate [data-model.md](./data-model.md) with database schema, RLS policies, and OKLCH color palette specifications.
