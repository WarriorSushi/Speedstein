openapi: 3.1.0
info:
  title: Speedstein PDF Generation API
  description: |
    High-performance PDF generation API with WebSocket RPC support.

    **Production Readiness Feature**: This contract covers endpoints affected by
    database schema creation, R2 storage integration, and crypto bug fixes.
  version: 1.0.0-production-readiness
  contact:
    name: Speedstein API Support
    email: support@speedstein.com
  license:
    name: Proprietary
servers:
  - url: https://api.speedstein.com
    description: Production server
  - url: https://api-staging.speedstein.com
    description: Staging server

security:
  - ApiKeyAuth: []

paths:
  /api/generate:
    post:
      summary: Generate a single PDF from HTML
      description: |
        Generates a PDF from HTML content. After production readiness feature:
        - Returns `pdf_url` (R2 CDN URL) instead of `pdfBuffer`
        - PDF is stored in R2 with tier-based lifecycle policies
        - Requires valid API key (hashed with async SHA-256)
      operationId: generatePdf
      tags:
        - PDF Generation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - html
              properties:
                html:
                  type: string
                  description: HTML content to convert to PDF
                  example: "<html><body><h1>Invoice #1234</h1></body></html>"
                options:
                  $ref: '#/components/schemas/PdfOptions'
      responses:
        '200':
          description: PDF generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PdfGenerationSuccess'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/QuotaExceeded'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/batch:
    post:
      summary: Generate multiple PDFs in batch
      description: |
        Generates multiple PDFs concurrently using promise pipelining.
        Uses Cap'n Web RPC for optimal performance.
      operationId: generateBatch
      tags:
        - PDF Generation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - jobs
              properties:
                jobs:
                  type: array
                  items:
                    type: object
                    required:
                      - html
                    properties:
                      html:
                        type: string
                      options:
                        $ref: '#/components/schemas/PdfOptions'
                  maxItems: 100
                  example:
                    - html: "<html><body>PDF 1</body></html>"
                      options: { format: "A4" }
                    - html: "<html><body>PDF 2</body></html>"
                      options: { format: "Letter" }
      responses:
        '200':
          description: Batch processing complete
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: array
                    items:
                      $ref: '#/components/schemas/PdfGenerationSuccess'
                  total:
                    type: integer
                    example: 2
                  successful:
                    type: integer
                    example: 2
                  failed:
                    type: integer
                    example: 0
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/QuotaExceeded'

  /api/quota:
    get:
      summary: Get current quota usage
      description: |
        Returns user's current quota usage and limits.
        Requires Supabase database with `subscriptions` and `usage_records` tables.
      operationId: getQuota
      tags:
        - Quota Management
      responses:
        '200':
          description: Quota information retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  plan:
                    type: string
                    enum: [free, starter, pro, enterprise]
                    example: "pro"
                  quota:
                    type: integer
                    description: Total PDFs allowed per month
                    example: 50000
                  used:
                    type: integer
                    description: PDFs generated this period
                    example: 12500
                  remaining:
                    type: integer
                    description: PDFs remaining
                    example: 37500
                  percentage:
                    type: number
                    format: float
                    description: Usage percentage (0-100)
                    example: 25.0
                  resetDate:
                    type: string
                    format: date-time
                    description: When quota resets
                    example: "2025-11-01T00:00:00Z"
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/rpc:
    get:
      summary: WebSocket RPC endpoint
      description: |
        Upgrades to WebSocket connection for Cap'n Web RPC.
        Enables bidirectional communication with promise pipelining.

        **Protocol**: Cap'n Web over WebSocket
        **Heartbeat**: 30-second ping/pong keepalive
      operationId: connectRpc
      tags:
        - RPC
      parameters:
        - in: header
          name: Upgrade
          required: true
          schema:
            type: string
            enum: [websocket]
        - in: header
          name: Connection
          required: true
          schema:
            type: string
            enum: [Upgrade]
        - in: header
          name: Sec-WebSocket-Version
          required: true
          schema:
            type: string
            example: "13"
      responses:
        '101':
          description: Switching Protocols to WebSocket
          headers:
            Upgrade:
              schema:
                type: string
                example: websocket
            Connection:
              schema:
                type: string
                example: Upgrade
        '401':
          $ref: '#/components/responses/Unauthorized'
        '400':
          description: Invalid WebSocket upgrade request

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: |
        API key for authentication.
        Format: `sk_live_xxxxxxxxxxxx` or `sk_test_xxxxxxxxxxxx`

        Keys are SHA-256 hashed before storage (production readiness requirement).

  schemas:
    PdfOptions:
      type: object
      description: PDF generation options (subset of Puppeteer's PDFOptions)
      properties:
        format:
          type: string
          enum: [Letter, Legal, A0, A1, A2, A3, A4, A5, A6]
          default: Letter
          example: A4
        width:
          oneOf:
            - type: string
              example: "210mm"
            - type: number
              example: 8.5
        height:
          oneOf:
            - type: string
              example: "297mm"
            - type: number
              example: 11
        margin:
          type: object
          properties:
            top:
              type: string
              example: "10mm"
            right:
              type: string
              example: "10mm"
            bottom:
              type: string
              example: "10mm"
            left:
              type: string
              example: "10mm"
        printBackground:
          type: boolean
          default: false
          description: Print CSS backgrounds
        landscape:
          type: boolean
          default: false
          description: Landscape orientation
        pageRanges:
          type: string
          example: "1-5, 8, 11-13"
          description: Page ranges to print (e.g., "1-3, 5")

    PdfGenerationSuccess:
      type: object
      required:
        - success
        - pdf_url
        - size
        - generationTime
        - requestId
      properties:
        success:
          type: boolean
          example: true
        pdf_url:
          type: string
          format: uri
          description: |
            CDN URL to access the PDF (R2 storage).
            **Production Readiness Change**: Replaces `pdfBuffer` field.
          example: "https://cdn.speedstein.com/pdfs/123e4567-e89b-12d3-a456-426614174000.pdf"
        size:
          type: integer
          description: PDF file size in bytes
          example: 45678
        generationTime:
          type: integer
          description: Time taken to generate PDF in milliseconds
          example: 1234
        requestId:
          type: string
          format: uuid
          description: Unique request identifier
          example: "123e4567-e89b-12d3-a456-426614174000"
        expiresAt:
          type: string
          format: date-time
          description: When the PDF will be deleted (tier-based)
          example: "2025-11-25T00:00:00Z"

    Error:
      type: object
      required:
        - success
        - error
        - code
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          description: Human-readable error message
          example: "Quota exceeded for this billing period"
        code:
          type: string
          description: Machine-readable error code
          example: "QUOTA_EXCEEDED"
        details:
          type: object
          description: Additional error context
          additionalProperties: true

  responses:
    Unauthorized:
      description: Invalid or missing API key
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            error: "Invalid API key"
            code: "UNAUTHORIZED"

    QuotaExceeded:
      description: Monthly PDF generation quota exceeded
      content:
        application/json:
          schema:
            allOf:
              - $ref: '#/components/schemas/Error'
              - type: object
                properties:
                  details:
                    type: object
                    properties:
                      quota:
                        type: integer
                        example: 50000
                      used:
                        type: integer
                        example: 50000
                      resetDate:
                        type: string
                        format: date-time
                        example: "2025-11-01T00:00:00Z"
          example:
            success: false
            error: "Quota exceeded for this billing period"
            code: "QUOTA_EXCEEDED"
            details:
              quota: 50000
              used: 50000
              resetDate: "2025-11-01T00:00:00Z"

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            error: "PDF generation failed"
            code: "INTERNAL_ERROR"
            details:
              message: "Browser rendering timeout"

tags:
  - name: PDF Generation
    description: Generate PDFs from HTML
  - name: Quota Management
    description: Monitor usage and limits
  - name: RPC
    description: WebSocket RPC for advanced use cases
